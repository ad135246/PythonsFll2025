from pybricks.hubs import PrimeHub
from pybricks.pupdevices import Motor, ColorSensor
from pybricks.robotics import DriveBase
from pybricks.parameters import Port, Direction, Button, Stop
from pybricks.tools import wait, StopWatch
from pybricks.parameters import Color

# -----------------------------
# Robot configuration
# -----------------------------
WHEEL_RADIUS_CM = 3.175
WHEEL_DIAMETER_MM = WHEEL_RADIUS_CM * 2 * 10  # cm -> mm
AXLE_TRACK_MM = 140  # IMPORTANT: set this to your real wheel-to-wheel distance

# Speed constants (cm/s)
SPEED_SLOW = 20
SPEED_MEDIUM = 30
SPEED_FAST = 70
SPEED_VERY_FAST = 100

# Acceleration constants (cm/sÂ²)
ACCEL_SLOW = 20
ACCEL_MEDIUM = 50
ACCEL_FAST = 100
ACCEL_VERY_FAST = 500

# Motor speed constants
MOTOR_SPEED_SLOW = 300
MOTOR_SPEED_MEDIUM = 500
MOTOR_SPEED_FAST = 1000

hub = PrimeHub()

# Drive motors (A/B). Adjust Directions if your robot drives backward.
left_motor = Motor(Port.A, Direction.COUNTERCLOCKWISE)
right_motor = Motor(Port.B, Direction.CLOCKWISE)
robot = DriveBase(left_motor, right_motor, WHEEL_DIAMETER_MM, AXLE_TRACK_MM)

# Attachment motors
motor_c = Motor(Port.C)
motor_d = Motor(Port.D)


# -----------------------------
# Shared helpers
# -----------------------------
def beep_ok():
    hub.speaker.beep(900, 80)


def beep_mission(n):
    """Beep N+1 times so kids can tell mission ran"""
    for _ in range(n + 1):
        hub.speaker.beep(700, 70)
        wait(80)


class EmergencyStopError(Exception):
    """Raised when emergency stop is triggered"""
    pass


def emergency_stop_check():
    """CENTER button = stop anytime"""
    if Button.CENTER in hub.buttons.pressed():
        robot.stop()
        left_motor.stop()
        right_motor.stop()
        motor_c.stop()
        motor_d.stop()
        hub.speaker.beep(200, 300)
        raise EmergencyStopError("Emergency stop")


def setup_drive(back=True):
    """Initialize robot for a mission run"""
    if back:
        robot.straight(-10)
    robot.reset()
    hub.imu.reset_heading(0)
    wait(100)
    robot.settings(straight_speed=300, straight_acceleration=300)
    beep_ok()


def mission(func):
    """Decorator to handle common mission setup/teardown"""
    def wrapper():
        setup_drive()
        try:
            func()
        except EmergencyStopError:
            pass  # Already handled in emergency_stop_check
        finally:
            robot.stop()
    return wrapper


def mission_no_backup(func):
    """Decorator for missions that don't need initial backup"""
    def wrapper():
        setup_drive(back=False)
        try:
            func()
        except EmergencyStopError:
            pass
        finally:
            robot.stop()
    return wrapper


# -----------------------------
# Motor helper functions
# -----------------------------
def lower_arm(motor, speed=300, duty=50):
    """Lower an arm motor until stalled"""
    motor.run_until_stalled(-speed, then=Stop.BRAKE, duty_limit=duty)


def raise_arm(motor, speed=400, duty=80):
    """Raise an arm motor until stalled"""
    motor.run_until_stalled(speed, then=Stop.BRAKE, duty_limit=duty)


def run_motor_for_degrees(m: Motor, degrees: int, speed: int, accel: int = 1000, stop=Stop.HOLD):
    """Run motor for specified degrees"""
    m.run_angle(speed, degrees, then=stop, wait=True)


# -----------------------------
# Driving functions
# -----------------------------
def gyro_turn(target_angle: float,
              mode: str = "medium",
              settle_tol: float = 2.0,
              settle_timeout_ms: int = 3000):
    """
    Hybrid turn with IMU correction.
    
    Args:
        target_angle: + right, - left
        mode: "slow" | "medium" | "fast"
        settle_tol: final tolerance in degrees
    """
    # Turn speed profiles
    turn_rates = {"slow": 80, "medium": 140, "fast": 200}
    turn_rate = turn_rates.get(mode, 140)

    # Settle margins
    settle_margins = {"slow": 0, "medium": 3, "fast": 5}
    settle_margin = settle_margins.get(mode, 3)

    emergency_stop_check()
    hub.imu.reset_heading(0)
    wait(50)

    robot.settings(turn_rate=turn_rate)

    # Phase A: bulk turn with DriveBase
    bulk = target_angle
    if abs(target_angle) > settle_margin:
        bulk = target_angle - (settle_margin if target_angle > 0 else -settle_margin)

    robot.turn(bulk)

    # Phase B: IMU settle (fine correction)
    sw = StopWatch()
    sw.reset()

    while True:
        emergency_stop_check()
        h = hub.imu.heading()
        err = target_angle - h

        if abs(err) <= settle_tol:
            break

        if sw.time() > settle_timeout_ms:
            break

        # Big error: turn again
        if abs(err) > 5:
            robot.turn(err * 0.8)
            continue

        # Small error: fine nudge
        speed = min(turn_rate, max(60, int(abs(err) * 6)))
        direction = 1 if err > 0 else -1

        left_motor.run(direction * speed)
        right_motor.run(-direction * speed)
        wait(50)  # Combined wait
        left_motor.stop()
        right_motor.stop()

    left_motor.stop()
    right_motor.stop()


def drive_cm(distance_cm, velocity_cm_s=SPEED_MEDIUM, acceleration_cm_s2=ACCEL_MEDIUM):
    """Drive a set distance in cm using DriveBase"""
    distance_mm = distance_cm * 10
    speed_mm_s = velocity_cm_s * 10
    accel_mm_s2 = acceleration_cm_s2 * 10

    robot.settings(straight_speed=speed_mm_s, straight_acceleration=accel_mm_s2)
    robot.straight(distance_mm)


def drive_cm_stall(distance_cm: float,
                   velocity_cm_s: float = SPEED_MEDIUM,
                   acceleration_cm_s2: float = ACCEL_MEDIUM,
                   poll_ms: int = 100) -> bool:
    """
    Drive with stall detection.
    Returns True if completed, False if stalled.
    """
    distance_mm = distance_cm * 10
    speed_mm_s = velocity_cm_s * 10
    accel_mm_s2 = acceleration_cm_s2 * 10

    robot.settings(straight_speed=speed_mm_s, straight_acceleration=accel_mm_s2)
    robot.straight(distance_mm, wait=False)

    while True:
        stalled_attr = getattr(robot, "stalled", None)
        stalled = stalled_attr() if callable(stalled_attr) else bool(stalled_attr)
        
        if stalled:
            robot.stop()
            return False

        done_fn = getattr(robot, "done", None)
        if callable(done_fn) and robot.done():
            robot.stop()
            return True

        wait(poll_ms)


# -----------------------------
# Mission implementations
# -----------------------------
@mission
def mission_0():
    drive_cm(15, SPEED_MEDIUM, ACCEL_MEDIUM)
    robot.turn(-12)
    wait(200)

    drive_cm(55, SPEED_MEDIUM, ACCEL_MEDIUM)
    wait(200)
    gyro_turn(55, mode="slow")
    wait(200)
    drive_cm(7, SPEED_MEDIUM, ACCEL_SLOW)

    run_motor_for_degrees(motor_d, -1000, MOTOR_SPEED_FAST)
    run_motor_for_degrees(motor_c, 50, MOTOR_SPEED_MEDIUM)
    
    gyro_turn(-35, mode="medium")
    drive_cm(-60, SPEED_VERY_FAST, ACCEL_VERY_FAST)
    gyro_turn(-90, mode="fast")
    drive_cm(-60, SPEED_VERY_FAST, ACCEL_VERY_FAST)


@mission
def mission_1():
    drive_cm(12, SPEED_MEDIUM, ACCEL_MEDIUM)
    gyro_turn(-45, mode="fast")
    run_motor_for_degrees(motor_c, 150, MOTOR_SPEED_SLOW)
    drive_cm(39, SPEED_MEDIUM, ACCEL_MEDIUM)

    lower_arm(motor_c, speed=100, duty=50)
    run_motor_for_degrees(motor_d, -500, MOTOR_SPEED_MEDIUM)
    run_motor_for_degrees(motor_c, 180, MOTOR_SPEED_FAST)
    drive_cm_stall(-15, SPEED_MEDIUM, ACCEL_SLOW)
    drive_cm_stall(10, SPEED_MEDIUM, ACCEL_SLOW)
    run_motor_for_degrees(motor_d, 600, MOTOR_SPEED_FAST)
    drive_cm(-35, SPEED_MEDIUM, ACCEL_FAST)


@mission_no_backup
def mission_2():
    """Motor wiggle pattern"""
    for _ in range(3):
        run_motor_for_degrees(motor_c, -180, 270)
        run_motor_for_degrees(motor_c, 180, 270)


@mission_no_backup
def mission_3():
    drive_cm(200, SPEED_FAST, ACCEL_MEDIUM)


@mission
def mission_4():
    """Adi Mission - Get the broom. Start from left edge of E"""
    drive_cm(69, SPEED_MEDIUM, ACCEL_MEDIUM)
    gyro_turn(-45)

    drive_cm(21, SPEED_SLOW, ACCEL_MEDIUM)

    run_motor_for_degrees(motor_d, 180, MOTOR_SPEED_FAST)  # raise garden bed
    raise_arm(motor_c, speed=200, duty=60)  # drop net
    lower_arm(motor_c, speed=200, duty=80)  # raise net to get broom

    drive_cm(-22, 17, ACCEL_VERY_FAST)  # back away from garden bed
    gyro_turn(-120, mode="fast")  # turn towards home

    drive_cm(61, SPEED_MEDIUM, ACCEL_VERY_FAST)  # drive towards home


@mission
def mission_5():
    drive_cm(41, SPEED_SLOW, ACCEL_SLOW)
    drive_cm(-11, 10, 15)
    drive_cm(19.5, SPEED_MEDIUM, ACCEL_MEDIUM)
    lower_arm(motor_c, speed=300, duty=50)  # drop gear mechanism
    drive_cm(2, SPEED_MEDIUM, ACCEL_SLOW)
    motor_d.run_until_stalled(-500, then=Stop.BRAKE, duty_limit=60)  # run gear mechanism
    raise_arm(motor_c, speed=400, duty=100)  # raise gear mechanism
    drive_cm(-50, SPEED_MEDIUM, ACCEL_MEDIUM)  # back to home


@mission
def mission_6():
    """Deposit Stuff"""
    drive_cm(50, SPEED_VERY_FAST, ACCEL_MEDIUM)  # drop stuff in deposit zone
    drive_cm(-50, SPEED_MEDIUM, ACCEL_MEDIUM)  # back to home


@mission
def mission_7():
    """Raise Hell"""
    drive_cm(79, SPEED_MEDIUM, ACCEL_MEDIUM)  # move forward to wall
    gyro_turn(90)
    raise_arm(motor_c, speed=600, duty=35)  # lower arm trolley
    drive_cm(13, SPEED_MEDIUM, ACCEL_MEDIUM)
    run_motor_for_degrees(motor_c, -400, MOTOR_SPEED_SLOW)  # raise arm trolley
    gyro_turn(45)  # turn towards dinosaur fossil
    lower_arm(motor_d, speed=600, duty=35)  # lower arm to hit fossil
    drive_cm(18, SPEED_MEDIUM, ACCEL_MEDIUM)

    run_motor_for_degrees(motor_d, 300, MOTOR_SPEED_MEDIUM)  # raise arm after hitting fossil
    gyro_turn(-30, mode="medium")


# -----------------------------
# Mission selector UI
# -----------------------------
MISSION_COLORS = [
    Color.RED,      # Mission 0
    Color.ORANGE,   # Mission 1
    Color.YELLOW,   # Mission 2
    Color.GREEN,    # Mission 3
    Color.BLUE,     # Mission 4
    Color.BLACK,    # Mission 5
    Color.MAGENTA,  # Mission 6
    Color.BROWN,    # Mission 7
]

MISSIONS = [
    ("Mission 0", mission_0),
    ("Mission 1", mission_1),
    ("Mission 2", mission_2),
    ("Mission 3", mission_3),
    ("Mission 4", mission_4),
    ("Mission 5", mission_5),
    ("Mission 6", mission_6),
    ("Mission 7", mission_7),
]

POLL_MS = 50


def set_mission_light(index):
    hub.light.on(MISSION_COLORS[index])


def show_selection(index):
    set_mission_light(index)
    hub.display.char(str(index))


def wait_release_all():
    while any(b in hub.buttons.pressed() for b in [Button.LEFT, Button.RIGHT, Button.CENTER]):
        wait(20)


def main():
    selected = 0
    show_selection(selected)

    while True:
        emergency_stop_check()
        pressed = hub.buttons.pressed()

        # Bluetooth button = immediate START
        if Button.BLUETOOTH in pressed:
            name, fn = MISSIONS[selected]
            hub.speaker.beep(1000, 200)
            hub.light.on(Color.WHITE)
            wait(200)

            try:
                fn()
                hub.speaker.beep(600, 150)  # done
            except EmergencyStopError:
                hub.speaker.beep(200, 500)
            except Exception:
                hub.speaker.beep(200, 500)

            set_mission_light(selected)
            show_selection(selected)

            # Wait until Bluetooth is released
            while Button.BLUETOOTH in hub.buttons.pressed():
                wait(20)
            continue

        # RIGHT button (tap)
        if Button.RIGHT in pressed:
            selected = (selected + 1) % len(MISSIONS)
            show_selection(selected)
            while Button.RIGHT in hub.buttons.pressed():
                wait(20)

        # LEFT button (tap)
        if Button.LEFT in pressed:
            selected = (selected - 1) % len(MISSIONS)
            show_selection(selected)
            while Button.LEFT in hub.buttons.pressed():
                wait(20)

        wait(POLL_MS)


main()
